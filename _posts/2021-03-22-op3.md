---
title: Processes and Threads (2)
tags:
- 운영체제
---

# 쓰레드의 사용
이전에는 프로세스의 개념밖에 없었는데, 실행하고 싶은 프로그램이 많아지고 복잡해지면서 프로세스 안의 **실행의 흐름도 여러개가 있으면 좋겠다**는 생각을 하게 되었습니다. 이렇게 만들어진 개념이 쓰레드입니다. 예를 들면 이 그림과 같습니다.  
![]({{ 'assets/blog/op8.PNG' | relative_url }})   
(커널 위에 있으므로) 일반 모드로 동작하는 프로세스가 세 갈래의 실행의 흐름이 나뉘어 각각 키보드, 디스크, ..등등의 실행에 관여하는 모습입니다.   
서버를 구성하는 세 가지 방법이 있는데,  다음과 같습니다.

| 모델 | 특징 |
| -------- | -------- | 
| Threads    | 동시에 수행할 수 있고, 디스크를 읽는 동안 blocked 상태가 될 수 있습니다. 그러나 다른 쓰레드는 동작합니다.    | 
| Single-threaded process     | 동시에 수행할 수 없고, blocked 상태가 되면 모든 작업이 멈춥니다.   | 
| Finite-state machine, FSM    | 동시에 수행할 수 있고, 인터럽트나 시스템 콜에 의해 blocked 상태가 되지 않습니다.    |   

# 고전 쓰레드 모델
![]({{'assets/blog/op9.PNG' | relative_url}})   
(a)와 같은 그림으로 어떤 프로그램의 병렬을 구현하다보면 **각각 프로세스와 데이터를 공유하는 것이 힘들었습니다.** 그래서 연산의 결과를 다시 이용하기 어려웠습니다. 하지만 (b)와 같이 한 프로세스 안에서 다중 쓰레드 방식을 이용하면 각 CPU에 쓰레드를 할당에 빠른 연산 속도를 기대할 수 있고, **연산의 결과를 쉽게 공유할 수 있습니다. 쓰레드는 글로벌 변수를 공유하기 때문입니다.** 
![]({{'assets/blog/op10.PNG' | relative_url}})   
이것은 프로세스마다, 쓰레드마다 필요한 자료구조가 정리되어 있는 자료인데 **각 쓰레드마다 스택 값을 할당합니다.** 그 스택에서는 로컬 변수들이나 리턴 주소를 저장합니다. 그러면 이런 그림의 형태로 프로세스가 구동하게 됩니다.  
![]({{'assets/blog/op11.PNG' | relative_url}})
# POSIX 쓰레드
다음은 vcpkg에 있는 pthread.h 헤더를 이용해 POSIX 쓰레드를 사용한 예제입니다.
<div class="colorscripter-code" style="color:#010101;font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important; position:relative !important;overflow:auto"><table class="colorscripter-code-table" style="margin:0;padding:0;border:none;background-color:#fafafa;border-radius:4px;" cellspacing="0" cellpadding="0"><tr><td style="padding:6px;border-right:2px solid #e5e5e5"><div style="margin:0;padding:0;word-break:normal;text-align:right;color:#666;font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important;line-height:130%"><div style="line-height:130%">1</div><div style="line-height:130%">2</div><div style="line-height:130%">3</div><div style="line-height:130%">4</div><div style="line-height:130%">5</div><div style="line-height:130%">6</div><div style="line-height:130%">7</div><div style="line-height:130%">8</div><div style="line-height:130%">9</div><div style="line-height:130%">10</div><div style="line-height:130%">11</div><div style="line-height:130%">12</div><div style="line-height:130%">13</div><div style="line-height:130%">14</div><div style="line-height:130%">15</div><div style="line-height:130%">16</div><div style="line-height:130%">17</div><div style="line-height:130%">18</div><div style="line-height:130%">19</div><div style="line-height:130%">20</div><div style="line-height:130%">21</div><div style="line-height:130%">22</div><div style="line-height:130%">23</div><div style="line-height:130%">24</div></div></td><td style="padding:6px 0;text-align:left"><div style="margin:0;padding:0;color:#010101;font-family:Consolas, 'Liberation Mono', Menlo, Courier, monospace !important;line-height:130%"><div style="padding:0 6px; white-space:pre; line-height:130%"><span style="color:#0086b3">#include</span>&nbsp;<span style="color:#ff3399"></span><span style="color:#a71d5d">&lt;</span>stdio.h<span style="color:#ff3399"></span><span style="color:#a71d5d">&gt;</span></div><div style="padding:0 6px; white-space:pre; line-height:130%"><span style="color:#0086b3">#include</span>&nbsp;<span style="color:#ff3399"></span><span style="color:#a71d5d">&lt;</span>pthread.h<span style="color:#ff3399"></span><span style="color:#a71d5d">&gt;</span></div><div style="padding:0 6px; white-space:pre; line-height:130%"><span style="color:#0086b3">#include</span>&nbsp;<span style="color:#ff3399"></span><span style="color:#a71d5d">&lt;</span>stdio.h<span style="color:#ff3399"></span><span style="color:#a71d5d">&gt;</span></div><div style="padding:0 6px; white-space:pre; line-height:130%"><span style="color:#0086b3">#define</span>&nbsp;NUMBER_OF_THREADS&nbsp;<span style="color:#0099cc">10</span></div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;</div><div style="padding:0 6px; white-space:pre; line-height:130%"><span style="color:#a71d5d">void</span>&nbsp;<span style="color:#ff3399"></span><span style="color:#a71d5d">*</span>print_hello_world(<span style="color:#a71d5d">void</span><span style="color:#a71d5d">*</span>&nbsp;tid)&nbsp;{</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066de2">printf</span>(<span style="color:#63a35c">"Hello&nbsp;World.&nbsp;from&nbsp;thread&nbsp;%d\n"</span>,&nbsp;(<span style="color:#066de2">int</span>)tid);</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;pthread_exit(<span style="color:#0086b3">NULL</span>);</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a71d5d">return</span>&nbsp;<span style="color:#0099cc">0</span>;</div><div style="padding:0 6px; white-space:pre; line-height:130%">}</div><div style="padding:0 6px; white-space:pre; line-height:130%"><span style="color:#066de2">int</span>&nbsp;main(<span style="color:#a71d5d">void</span>)&nbsp;{</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;pthread_t&nbsp;threads[NUMBER_OF_THREADS];</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066de2">int</span>&nbsp;status,&nbsp;i;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a71d5d">for</span>&nbsp;(i&nbsp;<span style="color:#ff3399"></span><span style="color:#a71d5d">=</span>&nbsp;<span style="color:#0099cc">0</span>;&nbsp;i&nbsp;<span style="color:#ff3399"></span><span style="color:#a71d5d">&lt;</span>&nbsp;NUMBER_OF_THREADS;&nbsp;i<span style="color:#ff3399"></span><span style="color:#a71d5d">+</span><span style="color:#ff3399"></span><span style="color:#a71d5d">+</span>)&nbsp;{</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066de2">printf</span>(<span style="color:#63a35c">"Main&nbsp;here.&nbsp;Creating&nbsp;thread&nbsp;%d\n"</span>,&nbsp;i);</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status&nbsp;<span style="color:#ff3399"></span><span style="color:#a71d5d">=</span>&nbsp;pthread_create(<span style="color:#ff3399"></span><span style="color:#a71d5d">&amp;</span>threads[i],&nbsp;<span style="color:#0086b3">NULL</span>,&nbsp;print_hello_world,&nbsp;(<span style="color:#a71d5d">void</span><span style="color:#a71d5d">*</span>)i);</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a71d5d">if</span>&nbsp;(status&nbsp;<span style="color:#ff3399"></span><span style="color:#a71d5d">!</span><span style="color:#ff3399"></span><span style="color:#a71d5d">=</span>&nbsp;<span style="color:#0099cc">0</span>)&nbsp;{</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#066de2">printf</span>(<span style="color:#63a35c">"Oops.&nbsp;pthread_create&nbsp;returned&nbsp;error&nbsp;code&nbsp;%d\n"</span>,&nbsp;status);</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a71d5d">return</span>&nbsp;<span style="color:#ff3399"></span><span style="color:#a71d5d">-</span><span style="color:#0099cc">1</span>;</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;}</div><div style="padding:0 6px; white-space:pre; line-height:130%">&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#a71d5d">return</span>&nbsp;<span style="color:#0099cc">0</span>;</div><div style="padding:0 6px; white-space:pre; line-height:130%">}</div></div><div style="text-align:right;margin-top:-13px;margin-right:5px;font-size:9px;font-style:italic"><a href="http://colorscripter.com/info#e" target="_blank" style="color:#e5e5e5text-decoration:none">Colored by Color Scripter</a></div></td><td style="vertical-align:bottom;padding:0 2px 4px 0"><a href="http://colorscripter.com/info#e" target="_blank" style="text-decoration:none;color:white"><span style="font-size:9px;word-break:normal;background-color:#e5e5e5;color:white;border-radius:10px;padding:1px">cs</span></a></td></tr></table></div>
